apiVersion: argoproj.io/v1alpha1
metadata:
  name: keystone-netapp-sync
  annotations:
    workflows.argoproj.io/title: Create SVM on Keystone Project creation
    workflows.argoproj.io/description: |
      Creates an SVM in Netapp when new Project is created.


      To test this workflow you can run it with the following:

      ```
      argo -n argo-events submit --from workflowtemplate/keystone-netapp-sync \
      -p event_type identity.project.created -p project_uuid=00000000-0000-0000-0000-000000000000

      Optionally, you can specify `aggregate_name` and `volume_size` parameters.
      ```

      Defined in `workflows/argo-events/workflowtemplates/keystone-netapp-sync.yaml`
kind: WorkflowTemplate
spec:
  entrypoint: sync-keystone-netapp
  serviceAccountName: workflow
  templates:
    - name: sync-keystone-netapp
      inputs:
        parameters:
          - name: event_type
          - name: project_uuid
          - name: aggregate_name
            default: aggr02_n02_NVME
          - name: volume_size
            default: 1GB

      container:
        image: ghcr.io/rackerlabs/understack/ironic-nautobot-client:latest
        command:
          - netapp-create-svm
        args:
          - --svm_name
          - "{{inputs.parameters.project_uuid}}"
          - --volume_size
          - "{{inputs.parameters.volume_size}}"
          - --aggregate_name
          - "{{inputs.parameters.aggregate_name}}"
          - --config
          - /etc/netapp_credentials.ini
        volumeMounts:
          - mountPath: /etc/netapp/netapp_nvme.conf
            name: netapp-ini
            readOnly: true
          - mountPath: /etc/openstack
            name: openstack-svc-acct
            readOnly: true
      volumes:
        - name: netapp-ini
          secret:
            secretName: netapp-config
        - name: openstack-svc-acct
          secret:
            secretName: openstack-svc-acct
