---
apiVersion: argoproj.io/v1alpha1
metadata:
  name: enroll-server
  annotations:
    workflows.argoproj.io/title: Perform server discovery and update Nautobot and Ironic
    workflows.argoproj.io/description: |
      Defined in `workflows/argo-events/workflowtemplates/enroll-server.yaml`
kind: WorkflowTemplate
spec:
  arguments:
    parameters:
      - name: ip_address
  templates:
    - name: enroll-server
      inputs:
        parameters:
          - name: ip_address
      container:
        image: ghcr.io/rackerlabs/understack/ironic-nautobot-client:latest
        command:
          - enroll-server
        args:
          - --bmc-ip-address
          - "{{workflow.parameters.ip_address}}"
        volumeMounts:
          - mountPath: /etc/openstack
            name: openstack-svc-acct
            readOnly: true
          - mountPath: /etc/nb-token/
            name: nb-token
            readOnly: true
          - mountPath: /etc/bmc_master/
            name: bmc-master
            readOnly: true
        env:
        - name: WF_NS
          value: "{{workflow.namespace}}"
        - name: WF_NAME
          value: "{{workflow.name}}"
        - name: WF_UID
          value: "{{workflow.uid}}"
      volumes:
        - name: bmc-master
          secret:
            secretName: bmc-master
        - name: nb-token
          secret:
            secretName: nautobot-token
        - name: openstack-svc-acct
          secret:
            secretName: openstack-svc-acct
