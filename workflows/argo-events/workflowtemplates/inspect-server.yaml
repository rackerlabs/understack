---
apiVersion: argoproj.io/v1alpha1
metadata:
  name: inspect-server
  annotations:
    workflows.argoproj.io/title: Perform Ironic inspection on a node/server
    workflows.argoproj.io/description: |
      Defined in `workflows/argo-events/workflowtemplates/inspect-server.yaml`
kind: WorkflowTemplate
spec:
  serviceAccountName: workflow
  entrypoint: inspect-server
  arguments:
    parameters:
      - name: node
  templates:
    - name: inspect-server
      inputs:
        parameters:
          - name: node
      dag:
        tasks:
          - name: node-id
            # convert a name to a UUID if needed
            template: openstack-read-param
            arguments:
              parameters:
                - name: object
                  value: node
                - name: object_ref
                  value: "{{inputs.parameters.node}}"
                - name: param
                  value: uuid
          - name: server-driver
            # read the currently used server driver
            depends: "node-id.Succeeded"
            template: openstack-read-param
            arguments:
              parameters:
                - name: object
                  value: node
                - name: object_ref
                  value: "{{tasks.node-id.outputs.result}}"
                - name: param
                  value: driver
          - name: server-start-state
            # read the current server state
            depends: "server-driver.Succeeded"
            template: openstack-read-param
            arguments:
              parameters:
                - name: object
                  value: node
                - name: object_ref
                  value: "{{tasks.node-id.outputs.result}}"
                - name: param
                  value: provision_state
          - name: fake-server
            # systems using the fake-hardware driver need to be skipped over
            depends: "server-start-state.Succeeded"
            template: openstack-set-cmd
            arguments:
              parameters:
                - name: object
                  value: node
                - name: flag
                  value: "--resource-class"
                - name: value
                  value: "fakehw"
                - name: obj_id
                  value: "{{tasks.node-id.outputs.result}}"
            when: >-
              '{{tasks.server-driver.outputs.result}}' == 'fake-hardware' &&
              '{{tasks.server-start-state.outputs.result}}' != 'active'
          - name: manage-server
            # move the server into manageable to inspect if needed
            depends: "server-start-state.Succeeded"
            template: openstack-wait-cmd
            arguments:
              parameters:
                - name: operation
                  value: "manage"
                - name: node_id
                  value: "{{tasks.node-id.outputs.result}}"
            when: >-
              '{{tasks.server-start-state.outputs.result}}' != 'manageable' &&
              '{{tasks.server-start-state.outputs.result}}' != 'active'
          - name: server-set-inspect-redfish
            # change the server to redfish based inspection
            depends: "server-start-state.Succeeded && (manage-server.Succeeded || manage-server.Skipped)"
            template: openstack-set-cmd
            arguments:
              parameters:
                - name: object
                  value: node
                - name: flag
                  value: "--inspect-interface"
                - name: value
                  value: "redfish"
                - name: obj_id
                  value: "{{tasks.node-id.outputs.result}}"
            when: >-
              '{{tasks.server-driver.outputs.result}}' == 'redfish' &&
              '{{tasks.server-start-state.outputs.result}}' != 'active'
          - name: server-set-inspect-idrac-redfish
            # change the server to idrac-redfish based inspection
            depends: "server-start-state.Succeeded && (manage-server.Succeeded || manage-server.Skipped)"
            template: openstack-set-cmd
            arguments:
              parameters:
                - name: object
                  value: node
                - name: flag
                  value: "--inspect-interface"
                - name: value
                  value: "idrac-redfish"
                - name: obj_id
                  value: "{{tasks.node-id.outputs.result}}"
            when: >-
              '{{tasks.server-driver.outputs.result}}' == 'idrac' &&
              '{{tasks.server-start-state.outputs.result}}' != 'active'
          - name: inspect-server-redfish
            # run redfish based inspection
            depends: "server-set-inspect-redfish.Succeeded || server-set-inspect-idrac-redfish.Succeeded"
            template: openstack-wait-cmd
            arguments:
              parameters:
                - name: operation
                  value: "inspect"
                - name: node_id
                  value: "{{tasks.node-id.outputs.result}}"
            when: "'{{tasks.server-start-state.outputs.result}}' != 'active'"
          - name: server-set-inspect-agent
            # change the server to agent based inspection
            depends: "server-start-state.Succeeded && (inspect-server-redfish.Succeeded || inspect-server-redfish.Omitted)"
            template: openstack-set-cmd
            arguments:
              parameters:
                - name: object
                  value: node
                - name: flag
                  value: "--inspect-interface"
                - name: value
                  value: "agent"
                - name: obj_id
                  value: "{{tasks.node-id.outputs.result}}"
            when: "'{{tasks.server-start-state.outputs.result}}' != 'active'"
          - name: inspect-server-agent
            # run agent based inspection
            depends: "server-start-state.Succeeded && server-set-inspect-agent.Succeeded"
            template: openstack-wait-cmd
            arguments:
              parameters:
                - name: operation
                  value: "inspect"
                - name: node_id
                  value: "{{tasks.node-id.outputs.result}}"
            when: "'{{tasks.server-start-state.outputs.result}}' != 'active'"
          - name: return-server
            # returns a server to its previous state if needed
            depends: "server-start-state.Succeeded && inspect-server-agent.Succeeded"
            template: openstack-wait-cmd
            arguments:
              parameters:
                - name: operation
                  value: "{{tasks.server-start-state.outputs.result}}"
                - name: node_id
                  value: "{{tasks.node-id.outputs.result}}"
            when: >-
              '{{tasks.server-start-state.outputs.result}}' != 'manageable' &&
              '{{tasks.server-start-state.outputs.result}}' != 'active' &&
              '{{tasks.server-start-state.outputs.result}}' != 'enroll'
    - name: openstack-wait-cmd
      inputs:
        parameters:
          - name: operation
          - name: node_id
      container:
        image: ghcr.io/rackerlabs/understack/openstack-client:2025.2
        command:
          - openstack
        args:
          - baremetal
          - node
          - "{{inputs.parameters.operation}}"
          - --wait
          - "0"
          - "{{inputs.parameters.node_id}}"
        env:
          - name: OS_CLOUD
            value: understack
        volumeMounts:
          - mountPath: /etc/openstack
            name: baremetal-manage
      volumes:
        - name: baremetal-manage
          secret:
            secretName: baremetal-manage
            items:
              - key: clouds.yaml
                path: clouds.yaml
    - name: openstack-set-cmd
      inputs:
        parameters:
          - name: object
          - name: flag
          - name: value
          - name: obj_id
      container:
        image: ghcr.io/rackerlabs/understack/openstack-client:2025.2
        command:
          - openstack
        args:
          - baremetal
          - "{{inputs.parameters.object}}"
          - set
          - "{{inputs.parameters.flag}}"
          - "{{inputs.parameters.value}}"
          - "{{inputs.parameters.obj_id}}"
        env:
          - name: OS_CLOUD
            value: understack
        volumeMounts:
          - mountPath: /etc/openstack
            name: baremetal-manage
      volumes:
        - name: baremetal-manage
          secret:
            secretName: baremetal-manage
            items:
              - key: clouds.yaml
                path: clouds.yaml
    - name: openstack-read-param
      inputs:
        parameters:
          - name: object
          - name: object_ref
          - name: param
      container:
        image: ghcr.io/rackerlabs/understack/openstack-client:2025.2
        command:
          - openstack
        args:
          - baremetal
          - "{{inputs.parameters.object}}"
          - show
          - "-f"
          - "value"
          - "-c"
          - "{{inputs.parameters.param}}"
          - "{{inputs.parameters.object_ref}}"
        env:
          - name: OS_CLOUD
            value: understack
        volumeMounts:
          - mountPath: /etc/openstack
            name: baremetal-manage
      volumes:
        - name: baremetal-manage
          secret:
            secretName: baremetal-manage
            items:
              - key: clouds.yaml
                path: clouds.yaml
