---
# Device Types repo: https://github.com/RSS-Engineering/undercloud-nautobot-device-types

- name: Check if device-types repo directory exists
  ansible.builtin.stat:
    path: /repo
  register: repo_dir

- name: Fail if device-types repo directory is missing
  ansible.builtin.fail:
    msg: "/repo directory does not exist. Cannot proceed with device types sync."
  when: not (repo_dir.stat.exists and repo_dir.stat.isdir)

- name: Collect device types from undercloud-nautobot-device-types repo
  ansible.builtin.set_fact:
    device_types_data: "{{ device_types_data | d([]) + [lookup('file', item.src) | from_yaml] }}"
  with_community.general.filetree: "/repo/device-types/"
  when: item.state == "file"
  check_mode: false

- name: Sync manufacturers
  networktocode.nautobot.manufacturer:
    url: "{{ nautobot_url }}"
    token: "{{ nautobot_token }}"
    name: "{{ item }}"
    description: "{{ item }}"
    state: present
  loop: "{{ device_types_data | community.general.json_query('[*].manufacturer') | unique }}"

- name: Loop through device types
  ansible.builtin.include_tasks: device_types.yml
  loop: "{{ device_types_data }}"
  loop_control:
    loop_var: device_type_item
