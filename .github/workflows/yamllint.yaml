name: Validate Manifests

on:
  push:
  pull_request:
  workflow_dispatch:
  merge_group:
    types: [checks_requested]

jobs:
  lint-yaml:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - run: pip install yamllint
      - run: yamllint -c .yamllint.yaml --format github .

  kustomize:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: azure/setup-kubectl@776406bce94f63e41d621b960d78ee25c8b76ede # v4
      - uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
        with:
          version: v3.18.4
      - uses: bmuschko/setup-kubeconform@5ccaecbbf012bcb1eeeab66e649db64a477ade8f # v1
      - name: validate kustomize with kubeconform
        run: |
          set -o errexit
          set -o pipefail
          items=$(find bootstrap -maxdepth 2 -name kustomization.yaml -exec dirname {} \;)
          items+=($(find operators -maxdepth 2 -name kustomization.yaml -exec dirname {} \;))
          items+=($(find components -maxdepth 2 -name kustomization.yaml -exec dirname {} \;))
          items+=($(find apps -maxdepth 2 -name kustomization.yaml -exec dirname {} \;))

          for item in ${items}; do
            echo "${item}"
            kubectl kustomize --enable-helm "${item}" | \
              kubeconform -skip=Secret -strict -ignore-missing-schemas
          done

  workflows-description:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: thiagodnf/yaml-schema-checker@3c4a632d4124b6c00e38b492b2eb35dea715e1ae # v0.0.12
        with:
          jsonSchemaFile: workflows/.workflow_with_description.schema.json
          yamlFiles: |
            workflows/argo-events/sensors/*.y*ml
            workflows/argo-events/workflowtemplates/*.y*ml

  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: reviewdog/action-shellcheck@4c07458293ac342d477251099501a718ae5ef86e # v1
