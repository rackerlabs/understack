---
name: terraform-build-test

on:
  schedule:
    - cron: '0 7,16 * * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: false

jobs:
  terraform-build-test:
    runs-on: rax-internal-access-ubuntu-latest
    defaults:
      run:
        working-directory: examples/tf-multi-node-build
    strategy:
      matrix:
        cloud: ["understack-dev", "understack-staging"]
    env:
      OS_CLOUD: ${{ matrix.cloud }}

    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

    - name: Setup OpenStack config
      env:
        OPENSTACK_CONFIG: ${{ secrets.OPENSTACK_CONFIG }}
      run: |
        mkdir -p ~/.config/openstack/
        echo $OPENSTACK_CONFIG | base64 --decode > ~/.config/openstack/clouds.yml

    - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3

    - run: terraform init

    - id: apply
      run: terraform apply -no-color -auto-approve

    - run: echo ${{ steps.apply.outputs.stdout }}

    - run: echo ${{ steps.apply.outputs.stderr }}

    - run: echo ${{ steps.apply.outputs.exitcode }}

    - name: Remove testing resources even if the terraform apply fails
      if: success() || failure()
      run: terraform destroy -auto-approve
