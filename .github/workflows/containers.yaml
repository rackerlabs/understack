name: Build non-OpenStack containers

on:
  push:
    tags:
      - v*
    branches:
      - main
    paths: &triggerpaths
      - "ansible/**"
      - "containers/ansible/**"
      - "containers/dnsmasq/**"
      - "containers/ironic-nautobot-client/**"
      - "containers/ironic-vnc-client/**"
      - "containers/understack-tests/**"
      - "containers/ironic-prometheus-exporter/**"
      - "python/**"
      - ".github/workflows/containers.yaml"
      - ".github/workflows/build-container-reuse.yaml"
  pull_request:
    types: [opened, synchronize, reopened, closed]
    paths: *triggerpaths
  workflow_dispatch:
  merge_group:
    types: [checks_requested]

jobs:
  build:
    strategy:
      matrix:
        container:
          - name: ansible
            target: prod
          - name: dnsmasq
            target: prod
          - name: ironic-nautobot-client
            target: prod
          - name: understack-tests
            target: prod
          - name: ironic-vnc-container
            target: ''
            dockerfile_path: ./containers/ironic-vnc-container/Dockerfile
            context_path: "./containers/ironic-vnc-container/"
            prebuild_script: ./sync_from_upstream.sh
            prebuild_script_working_dir: containers/ironic-vnc-container/
          - name: shell-operator-ironic
            target: prod
          - name: nautobot
            target: prod
          - name: ironic-prometheus-exporter
            target: prod
    uses: ./.github/workflows/build-container-reuse.yaml
    secrets: inherit
    with:
      container_name: ${{ matrix.container.name }}
      dockerfile_path: ${{ matrix.container.dockerfile_path || format('containers/{0}/Dockerfile', matrix.container.name) }}
      target: ${{ matrix.container.target }}
      context_path: ${{ matrix.container.context_path || '{{defaultContext}}' }}
      prebuild_script: ${{ matrix.container.prebuild_script }}
      prebuild_script_working_dir: ${{ matrix.container.prebuild_script_working_dir }}
