---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  # the same as using namespace-install.yaml but easier to follow what the
  # actual pieces we are using are
  - https://github.com/argoproj/argo-workflows/manifests/base?ref=v3.5.10
  - https://github.com/argoproj/argo-workflows/manifests/namespace-install/argo-server-rbac?ref=v3.5.10
  - https://github.com/argoproj/argo-workflows/manifests/namespace-install/workflow-controller-rbac?ref=v3.5.10

  # ingress for workflows.${DNS_ZONE} to the argo server for the UI
  - ingress.yaml

  # external secret for SSO auth
  - external-secret-argo-sso.yaml

# keep all the images consistent
images:
  - name: quay.io/argoproj/workflow-controller
    newTag: v3.5.10
  - name: quay.io/argoproj/argoexec
    newTag: v3.5.10
  - name: quay.io/argoproj/argocli
    newTag: v3.5.10

patches:
# see the patch for details on the change
- target:
    group: apps
    version: v1
    kind: Deployment
    name: argo-server
  path: ./argo-server-deployment.yaml

# see the patch for details on the change
- target:
    group: apps
    version: v1
    kind: Deployment
    name: workflow-controller
  path: ./workflow-controller-deployment.yaml

# see the patch for details on the change
- target:
    group: rbac.authorization.k8s.io
    version: v1
    kind: Role
    # this is the role that the workflow-controller runs with
    name: argo-role
  path: ./workflow-controller-role.yaml

# apply our configuration changes to the configmap
configMapGenerator:
  - name: workflow-controller-configmap
    behavior: merge
    files:
      - sso
      - workflowDefaults=workflow-defaults
