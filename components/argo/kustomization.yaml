---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  # We are doing upstream's namespace-install.yaml but since we
  # want the actual workflows to run in a different namespace
  # the roles are created there
  - https://github.com/argoproj/argo-workflows/manifests/base?ref=v3.5.10
  # give the workflow controller access it needs
  - workflow-controller-runtime.yaml
  # give the argo-server access it needs
  - argo-server-runtime.yaml

  # ingress for workflows.${DNS_ZONE} to the argo server for the UI
  - ingress.yaml

  # external secret for SSO auth
  - external-secret-argo-sso.yaml

# keep all the images consistent
images:
  - name: quay.io/argoproj/workflow-controller
    newTag: v3.5.10
  - name: quay.io/argoproj/argoexec
    newTag: v3.5.10
  - name: quay.io/argoproj/argocli
    newTag: v3.5.10

patches:
# see the patch for details on the change
- target:
    group: apps
    version: v1
    kind: Deployment
    name: argo-server
  path: ./argo-server-deployment.yaml

# see the patch for details on the change
- target:
    group: apps
    version: v1
    kind: Deployment
    name: workflow-controller
  path: ./workflow-controller-deployment.yaml

# apply our configuration changes to the configmap
configMapGenerator:
  - name: workflow-controller-configmap
    behavior: merge
    files:
      - sso
      - workflowDefaults=workflow-defaults
