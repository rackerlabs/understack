---
apiVersion: batch/v1
kind: Job
metadata:
  name: octavia-post-deployment-job
  generateName: octavia-post-deployment-job-
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  template:
    spec:
      containers:
        - name: octavia-post-deploy
          image: ghcr.io/rackerlabs/understack/ansible:latest
          imagePullPolicy: Always
          command: ["ansible-runner", "run", "/runner", "-vvv", "--playbook", "openstack_octavia.yaml"]
          env:
            - name: OS_CLOUD
              value: understack
          volumeMounts:
            - name: ansible-inventory
              mountPath: /runner/inventory/hosts.yaml
              subPath: hosts.yaml
            - name: ansible-kubernetes-inventory
              mountPath: /runner/inventory/inventory.yaml
              subPath: inventory.yaml
            - name: ansible-group-vars
              mountPath: /runner/inventory/group_vars/
            - name: openstack-svc-acct
              mountPath: /etc/openstack
              readOnly: true
      volumes:
        - name: runner-data
          emptyDir: {}
        - name: ansible-inventory
          configMap:
            name: ansible-inventory
        - name: ansible-kubernetes-inventory
          configMap:
            name: ansible-kubernetes-inventory
        - name: ansible-group-vars
          configMap:
            name: ansible-group-vars
        - name: openstack-svc-acct
          secret:
            secretName: openstack-svc-acct
      restartPolicy: OnFailure
