---
apiVersion: batch/v1
kind: Job
metadata:
  name: octavia-post-deployment-job
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/sync-wave: "1"
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation,HookSucceeded
spec:
  backoffLimit: 2
  template:
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: ansible
          image: ghcr.io/rackerlabs/understack/ansible:latest
          imagePullPolicy: Always
          command: ["ansible-runner", "run", "/runner", "-vvv", "--playbook", "openstack_octavia.yaml"]
          resources:
            requests:
              cpu: "1000m"
              memory: "512Mi"
            limits:
              cpu: "1000m"
              memory: "512Mi"
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: false
          env:
            - name: OS_CLOUD
              value: understack
          volumeMounts:
            - name: ansible-inventory
              mountPath: /runner/inventory/hosts.yaml
              subPath: hosts.yaml
            - name: ansible-kubernetes-inventory
              mountPath: /runner/inventory/inventory.yaml
              subPath: inventory.yaml
            - name: ansible-group-vars
              mountPath: /runner/inventory/group_vars/
            - name: infrasetup
              mountPath: /etc/openstack
              readOnly: true
      volumes:
        - name: runner-data
          emptyDir: {}
        - name: ansible-inventory
          configMap:
            name: ansible-inventory
        - name: ansible-kubernetes-inventory
          configMap:
            name: ansible-kubernetes-inventory
        - name: ansible-group-vars
          configMap:
            name: ansible-group-vars
        - name: infrasetup
          secret:
            secretName: infrasetup
            items:
              - key: clouds.yaml
                path: clouds.yaml
      restartPolicy: OnFailure
