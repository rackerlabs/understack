---
apiVersion: external-secrets.io/v1
kind: ClusterSecretStore
metadata:
  name: nautobot-token-store
spec:
  provider:
    webhook:
      url: "http://nautobot-default.nautobot.svc.cluster.local/api/plugins/undercloud-vni/user-with-token"
      method: POST
      headers:
        Content-Type: application/json
        Authorization: 'Token {{ .auth.apitoken }}'
      body: '{"username":"{{ .remoteRef.key }}"}'
      result:
        jsonPath: "$.key"
      secrets:
        - name: auth
          secretRef:
            name: nautobot-superuser
            namespace: nautobot

---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: ansible-nautobot-token
  namespace: nautobot
spec:
  refreshInterval: 24h
  secretStoreRef:
    kind: ClusterSecretStore
    name: nautobot-token-store
  target:
    name: ansible-nautobot-token
    creationPolicy: Owner
    deletionPolicy: Delete
  data:
    - secretKey: apitoken
      remoteRef:
        key: undercloud-ansible
