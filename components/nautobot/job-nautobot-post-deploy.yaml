---
apiVersion: batch/v1
kind: Job
metadata:
  name: nautobot-post-deploy
  labels:
    app.kubernetes.io/name: nautobot
    app.kubernetes.io/component: post-deploy
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/sync-wave: "1"
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation,HookSucceeded
spec:
  backoffLimit: 2
  template:
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: ansible
          image: ghcr.io/rackerlabs/understack/ansible:latest
          imagePullPolicy: Always
          command: ["ansible-runner", "run", "/runner", "--playbook", "nautobot-post-deploy.yaml"]
          resources:
            requests:
              cpu: "1000m"
              memory: "512Mi"
            limits:
              cpu: "1000m"
              memory: "512Mi"
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: false
          env:
            - name: NAUTOBOT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: nautobot-superuser
                  key: apitoken
            - name: NAUTOBOT_URL
              value: http://nautobot-default.nautobot.svc.cluster.local
          volumeMounts:
            - name: ansible-inventory
              mountPath: /runner/inventory/
            - name: ansible-group-vars
              mountPath: /runner/inventory/group_vars/
            - name: device-types
              mountPath: /runner/data/device-types/
      volumes:
        - name: ansible-inventory
          configMap:
            name: ansible-inventory
        - name: ansible-group-vars
          configMap:
            name: ansible-group-vars
        - name: device-types
          configMap:
            name: device-types
      restartPolicy: OnFailure
